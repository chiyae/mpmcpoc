
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       AUTH & ROLE HELPERS
       ============================ */

    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function hasUserDoc() {
      return isAuthenticated() && exists(userDocPath());
    }

    function getUserRole() {
      // Safe role resolution â€” NEVER throws
      return hasUserDoc()
        ? get(userDocPath()).data.role
        : "none";
    }

    function isAdmin() {
      return getUserRole() == "admin";
    }

    function isCashier() {
      return getUserRole() == "cashier";
    }

    function isPharmacy() {
      return getUserRole() == "pharmacy";
    }

    /* ============================
       MASTER DATA (BOOT SAFE)
       ============================ */

    match /items/{itemId} {
      allow read: if isAuthenticated();          // Empty-safe read for all users
      allow write: if isAdmin();                 // Only admins can modify master item list
    }

    match /vendors/{vendorId} {
      allow read: if isAuthenticated();          // Empty-safe read for all users
      allow write: if isAdmin();                 // Only admins can modify vendors
    }

    match /services/{serviceId} {
      allow read: if isAuthenticated();          // Empty-safe read for all users
      allow write: if isAdmin();                 // Only admins can modify services
    }

    /* ============================
       SETTINGS (STRICT)
       ============================ */

    match /settings/{settingId} {
      // Only admins can read or write settings
      allow read, write: if isAdmin();
    }

    /* ============================
       USERS (BOOTSTRAP SAFE)
       ============================ */

    match /users/{userId} {
      // A user can always read their own profile document
      allow get: if isAuthenticated() && request.auth.uid == userId;

      // Admins can manage all user documents
      allow list, create, update, delete: if isAdmin();
    }

    /* ============================
       BILLINGS (ROLE-RESTRICTED)
       ============================ */

    match /billings/{billingId} {
      // Only Cashiers and Admins can list or read bills
      allow list, read: if isCashier() || isAdmin();

      // Only Cashiers and Admins can create or update bills
      allow create, update, delete: if isCashier() || isAdmin();
    }

    /* ============================
       STOCKS (ROLE-RESTRICTED)
       ============================ */

    match /stocks/{stockId} {
      // Only Pharmacy users and Admins can list or read stock info
      allow list, read: if isPharmacy() || isAdmin();

      // Only Pharmacy users and Admins can write to stock
      allow write: if isPharmacy() || isAdmin();
    }

    /* ============================
       INTERNAL ORDERS (ROLE-RESTRICTED)
       ============================ */

    match /internalOrders/{orderId} {
      // Only Pharmacy users and Admins can list or read internal orders
      allow list, read: if isPharmacy() || isAdmin();

      // Only Pharmacy users and Admins can create new orders
      allow create: if isPharmacy() || isAdmin();

      // Only Admins can update or delete existing orders
      allow update, delete: if isAdmin();
    }

  }
}
