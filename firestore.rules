
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       AUTH & ROLE HELPERS
       ============================ */

    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function hasUserDoc() {
      return isAuthenticated() && exists(userDocPath());
    }

    function getUserRole() {
      // Safe role resolution â€” NEVER throws
      return hasUserDoc()
        ? get(userDocPath()).data.role
        : "none";
    }

    function isAdmin() {
      return getUserRole() == "admin";
    }

    function isCashier() {
      return getUserRole() == "cashier";
    }

    function isPharmacy() {
      return getUserRole() == "pharmacy";
    }

    /* ============================
       MASTER DATA (BOOT SAFE)
       ============================ */

    match /items/{itemId} {
      allow read: if isAuthenticated();          // Empty-safe
      allow write: if isAdmin();
    }

    match /vendors/{vendorId} {
      allow read: if isAuthenticated();          // Empty-safe
      allow write: if isAdmin();
    }

    match /services/{serviceId} {
      allow read: if isAuthenticated();          // Empty-safe
      allow write: if isAdmin();
    }

    /* ============================
       SETTINGS (STRICT)
       ============================ */

    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }

    /* ============================
       USERS (BOOTSTRAP SAFE)
       ============================ */

    match /users/{userId} {
      // User can always read own profile (even first login)
      allow get: if isAuthenticated() && request.auth.uid == userId;

      // Admin capabilities
      allow list, create, update, delete: if isAdmin();
    }

    /* ============================
       BILLINGS (EMPTY SAFE)
       ============================ */

    match /billings/{billingId} {
      // Allow empty reads so UI can load. List is now more restrictive.
      allow list, read: if isCashier() || isAdmin();

      // Writes remain role-restricted
      allow create, update, delete: if isCashier() || isAdmin();
    }

    /* ============================
       STOCKS (EMPTY SAFE)
       ============================ */

    match /stocks/{stockId} {
      // Allow empty reads so UI can load. List is now more restrictive.
      allow list, read: if isPharmacy() || isAdmin();
      allow write: if isPharmacy() || isAdmin();
    }

    /* ============================
       INTERNAL ORDERS (EMPTY SAFE)
       ============================ */

    match /internalOrders/{orderId} {
      // Allow empty reads so UI can load. List is now more restrictive.
      allow list, read: if isPharmacy() || isAdmin();
      allow create: if isPharmacy() || isAdmin();
      allow update, delete: if isAdmin();
    }

  }
}
