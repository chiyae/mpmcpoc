rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      // Check for an 'admin' role in the user's custom claims.
      // This is the correct and secure way to check for admin privileges.
      return request.auth.token.role == 'admin';
    }

    match /users/{userId} {
      // Admins can perform any action on any user document.
      allow list, get, create, update, delete: if isAdmin();
      
      // A non-admin user can get or update their OWN document.
      allow get, update: if request.auth.uid == userId;
      
      // A user can create their own document upon first sign-up.
      // This rule enables self-registration.
      allow create: if request.auth.uid == userId;
    }
  }
}
