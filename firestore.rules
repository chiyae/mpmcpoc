rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the requesting user's Auth token has an 'admin' custom claim.
    // This is the correct way to handle role-based access without circular reads.
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    match /users/{userId} {
      // READ (get a single document)
      // Allow a user to read their own document, or allow an admin to read any user document.
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // LIST (query the collection)
      // Allow an admin to list all users. This is what `useCollection` needs.
      // Non-admins cannot list all users.
      allow list: if request.auth != null && isAdmin();

      // UPDATE
      // Allow a user to update their own document, or allow an admin to update any user document.
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // CREATE
      // Allow any authenticated user to create their OWN document upon sign-up.
      // An admin can also create users (covered by the AddUserForm logic on the client).
      allow create: if request.auth != null;

      // DELETE
      // Allow only an admin to delete a user document.
      allow delete: if request.auth != null && isAdmin();
    }
  }
}
